---
layout: post
title: "Getting Started in Security: Writing and Understanding Malware Holistically"
permalink: /2020/getting-started-writing-malware/
description: "Malware often unites \"hackers getting started with programming\" and \"programmers starting with hacking.\" This post goes over important guidance and context for people writing, extending, and dissecting their first pieces of malware."
date: 2020-09-06 00:00:00
tags:
- malware
- intro
---

I often find that students of security have the resources to build their first malicious programs easily. It's not a fast start - for hackers just learning to be programmers, writing your first program that does anything of worth can take weeks or months. But between online guides, books, and tons of open source malware demos, there's plenty to help you get started.

However, these resources don't give context for further development and understanding across the security field. There's little documentation that brings together anti-malware or forensic contexts for novice malware authors. Many questions arise, such as:

* Why is my malware "undetectable" to major anti-malware providers on VirusTotal?
* Could I really just drop this anywhere and achieve great success with whatever it does?
* Am I a certified [APT](https://en.wikipedia.org/wiki/Advanced_persistent_threat) now? ᕙ(⇀‸↼‶)ᕗ

This guide will attempt to build a holistic educational path which should take a few months for novice hackers, depending on how much time you can dedicate per week and whether or not you have broader security or programming background. I will not hold your hand and this guide will not have step-by-step walkthroughs of anything (though it will link to some) - rather, I will provide guidance for your own longer research journey. It may help you to bookmark this page and return to it as you progress.

But before we jump in...

## Disclaimer

I do not condone making or using malware for *any* illegal or unethical purposes. I advocate for malware authorship in only two areas:

* You are writing malware for ethical and self-educational purposes, or
* You are an ethical hacker working within the bounds of your contract.

Malware authors (both new and existing) should be cognizant of the changing cyber law landscape. You must always ensure that designing, possessing, or open sourcing the malware you write is legal in your jurisdiction. This may also be subject to what exactly your malware does - a good example is if your code circumvents copyright protection per [17 USC § 1201(a)(2)](https://www.law.cornell.edu/uscode/text/17/1201) - even if it's for educational purposes only, you would be liable. I don't make the rules. Always work with a qualified lawyer to understand your personal liabilities when you are unsure.

## Starting Simple

As you know, malware is software which is intentionally designed to cause damage to a user, computer, or network.

* wyd? lmao
* if you really want to optimize for relevance to this particular guide, build something which involves a malicious client and some remote attacker-controlled server, as we'll be discussing networking as well.

#### Security Folk Trying Development

For students of security thinking about what you would want to write for your first malware - especially if this is one of your first experiences programming - you should keep it reasonably simple. Focus on executing one, or few, tasks well. Some ideas include:

* A program that steals Chrome cookies and uploads them to a server you control. Maybe it could steal cookies from multiple browsers or support multiple operating systems, too!
* A program which polls a server for commands, executes them on the machine, and returns the output. Could this also track names or other identifying information of the systems that the program is running on?
* 

#### Programming Folk Trying Security

* you have experience in dev, so build a broader security project to learn about security

#### Languages

* now that you know what you want to do - and have something you're passionate enough about to keep with when the going gets tough - how will you implement it?
* cover major languages such as Python, Go(?), C/C++, shell, link to free content covering each
* for people optimizing the impact of this guide, a compiled language works best, but anything will do. personal recommendation is python.

#### Tips

* there may be libraries which tempt you - track what you're importing & understand its ramifications
* use VCS holy shit
* stackoverflow is your friend, copying and pasting code is not
* rubber duck debugging

#### Wrapping Up

* test it!
* document it!
* open source it?

## Detection by Anti-Malware

* what were the results?
* what could have influenced those results? libraries? MSF(venom?)? etc.

Now, upload that malware to VirusTotal. Why does nothing detect it? There are several reasons which I detailed in another discussion about simple "undetectable" malware, but they can be summed up as: this isn't a program that people have used in an active engagement, and it doesn't really have too much in common with real malware threats yet.

Signatures and signature-derived heuristics (ex fuzzy hashes) won't catch this because it's all-new.

Behavioral analysis engines may or may not catch it because it's simple.

Classification algorithms may or may not recognize it, but I think that has to do with the above - it's surely malicious, but it's not really dangerous.

## Reverse Engineering & Obfuscation

* ghidra time

Your code is minimally obscured, and its function is easily ascertained with any reverse engineering suite. Any Jr. Analyst that knows x86 would figure out exactly what it is and does immediately, raising the alarms, when you ideally want to pass at least a sniff test here to call it "undetectable."

Start researching malware obfuscation. Reverse engineer your binaries. Find out what the big boys are doing!

Upload it to VirusTotal again - do more scanners pick it up, even though analysts might not have such an easy time anymore? Explore why or why not! Keep learning!

## Extending and Advancing

So it's lean, but maybe make it mean, can you get to bigger and badder targets? How about dumping out Windows credentials from the registry? Can your malware install itself as a service for persistence? How do other malware strains do those things?

* you're using a VCS, RIGHT?
* research time
* scanning & rescanning to see if there are any particular changes that strongly influence detection rates from the host protection perspective

## Networking, Traffic Inspection, and Threat Intelligence

* IDS fundamentals
* threat protection fundamentals, what's plaintext, what's not; protocols
* what's your infrastructure look like? what would happen if you tried to run this for real? ISP + VPS payment traces etc.

What would happen if you tried to deploy this to an area where sensitive information - even something as "benign" as a browser history - was of critical importance? Would contemporary NGFWs or UTMs permit the use of outgoing FTP to an untrusted server? Would you have been better off using a more common protocol, such as HTTPS (both to blend in and to encrypt the data you are sending in transit)?

## Application Security for Malware Authors

* can you hack your own malware?
* are malicious clients authed?
* could you DoS your server?
* provide examples of shitty malware fiestas

## Further Works & Closing Thoughts

* start from scratch for your next projects, this one's a mess
* new people in the malware field bring tons of fresh ideas and content
* living document et al.