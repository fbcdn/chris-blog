---
layout: post
title: "Getting Started in Security: Writing and Understanding Malware Holistically"
permalink: /2020/getting-started-writing-malware/
description: "Malware often unites \"hackers getting started with programming\" and \"programmers starting with hacking.\" This post goes over important guidance and context for people writing, extending, and dissecting their first pieces of malware."
date: 2020-09-06 00:00:00
tags:
- malware
- intro
---

I often find that students of security have the resources to build their first malicious programs easily. It's not a fast start - for hackers just learning to be programmers, writing your first program that does anything of worth can take days, weeks, or even months. But between online guides, books, and tons of open source malware demos, there's plenty to help you get started.

However, these resources don't give context for further development and understanding across the security field. There's little documentation that brings together anti-malware or forensic contexts for novice malware authors. Many questions arise, such as:

* Why is my malware "undetectable" to major anti-malware providers on VirusTotal?
* Could I really just drop this anywhere and achieve great success with whatever it does?
* Am I a certified [APT](https://en.wikipedia.org/wiki/Advanced_persistent_threat) now? ᕙ(⇀‸↼‶)ᕗ

This guide will attempt to build a holistic educational path which should take a few months for novice hackers, depending on how much time you can dedicate per week and whether or not you have more security or programming background. I will not hold your hand and this guide will not have step-by-step walkthroughs of anything (though it will link to some) - rather, I will provide guidance for your own longer research journey. It may help you to bookmark this page and return to it as you progress.

But before we jump in...

## Disclaimer

I do not condone making or using malware for *any* illegal or unethical purposes. I advocate for malware authorship in only two areas:

* You are writing malware for ethical and self-educational purposes, or
* You are an ethical hacker working within the bounds of your contract.

Malware authors (both new and existing) should be cognizant of the changing cyber law landscape. You must always ensure that designing, possessing, or open sourcing the malware you write is legal in your jurisdiction. This may *also* be subject to what exactly your malware does - a good example is if your code circumvents copyright protection per [17 USC § 1201(a)(2)](https://www.law.cornell.edu/uscode/text/17/1201) - even if it's for educational purposes only, you would be liable. I don't make the rules. Always work with a qualified lawyer to understand your personal liabilities when you are unsure.

## Starting Simple

As you probably know, malware is software which is intentionally designed to cause damage to a user, computer, or network.

That's really it, and you should find something which would be fun to do, but also doable for your skill level in coding or security. [Marcus Hutchins](https://www.malwaretech.com/)' first released malware was a [password stealer](https://www.wired.com/story/confessions-marcus-hutchins-hacker-who-saved-the-internet/), which dumped & decrypted passwords out of Internet Explorer. It's great work. Was it pivotal to the malware ecosystem? Well, no. But that's the point - everyone starts somewhere, pick somewhere you are going to be comfortable starting, and build your knowledge on that solid foundation.

People with different backgrounds will therefore necessarily start in different places and with different goals initially. The following are examples that could help you get started, but again, what's most important here is that it's a project that gets you excited. If that's bigger or smaller things I recommend, that's OK. If you pick something up and decide you want to scrap it and start something new, that's OK too. This is a guide, not a manual.

##### Security Folk Trying Development

For students of security thinking about what you would want to write for your first malware - especially if this is one of your first experiences programming - you should keep it reasonably simple. Focus on executing one, or few, tasks well. Some ideas include:

* Could you steal Chrome cookies and upload them to a server you control? Could you extend this to support many browsers and/or multiple operating systems?
* Could you create a program which installs itself as a service on a computer, then polls a remote server for commands to execute? Could this program identify the computer it's installed on? Could the server only tell certain infected computers to execute certain commands? Could the malicious client upload screenshots or files to the server?

##### Development Folk Trying Security

For students of software thinking about security projects, while you can certainly focus on doing few tasks well (as above), you could also take the time to do a deeper dive on security concepts & deliver a more complex malware. Some possibilities include:

* Could you write modular malware, which connects back to a command-and-control server, then can be told to download and run additional payloads such as keyloggers, network scanners, remote access tools, etc?
* Could you write malware which reads commands exclusively from common public services, so your command-and-control traffic is (less) obvious, such as encoding commands into images with steganography and then having your client download them from Imgur? Could you find the URL of the images to download by reading the third letter of each song in a Spotify playlist?

#### Languages

Now that you know what you want to do - and have something you're passionate enough about to keep with when the going gets tough - how will you implement it? Developers probably have a language in mind, but we'll go over some pros and cons of a few options within the context of writing your malware.

If you want to maximize the impact of this guide, you should use a [compiled language](https://en.wikipedia.org/wiki/Compiled_language) such as C, Go, Rust, etc. for your malware (since we'll be discussing reverse engineering later), but you can use any language for any server-side components (ex. command and control systems).

##### C - It's Important

C is a good option for writing malware, mainly because it can be compiled to run natively on any platform, but also there are many options and guides for making your C code harder to reverse engineer. I believe it is important to learn at a basic level for many security or security-interested programmers, as [memory safety](https://en.wikipedia.org/wiki/Memory_safety) is still a rampant issue, responsible for [~70%](https://msrc-blog.microsoft.com/2019/07/18/we-need-a-safer-systems-programming-language/) of CVEs issued by Microsoft between 2006 and 2018.

However, since C allows programmers to manage memory themselves, it is more complex to learn than languages which don't allow direct memory access. It's also not as commonly used for web APIs, though there are some frameworks which allow it to be used for web more seamlessly (ex. [Kore](https://kore.io/)).

##### Python - It's Easy

Python is an excellent language for beginners due to its simplicity and massive community. It's highly recommended for security engineers since it's easy to prototype with, and pentesters, analysts, etc. tend to use it frequently.

However, Python isn't frequently used to write malware *in the wild*, principally because Python is an interpreted language and requires any system to have the Python interpreter installed (or bundled) before Python scripts can be run, increasing payload size and complexity. Windows, holding the lion's share of the workstation market, doesn't include a Python interpreter by default. Another weakness in this domain is that while Python *can* be obfuscated, Python obfuscation techniques aren't as mature as C obfuscation techniques.

##### Go - It's... Go

* cover major languages such as Python, Go(?), C/C++, shell, link to free content covering each
* for people optimizing the impact of this guide, a compiled language works best, but anything will do. personal recommendation is python.

#### Tips

* there may be libraries which tempt you - track what you're importing & understand its ramifications
* use VCS holy shit
* stackoverflow is your friend, copying and pasting code is not
* rubber duck debugging

#### Wrapping Up

* test it!
* document it!
* open source it?

## Detection by Anti-Malware

* what were the results?
* what could have influenced those results? libraries? MSF(venom?)? etc.

Now, upload that malware to VirusTotal. Why does nothing detect it? There are several reasons which I detailed in another discussion about simple "undetectable" malware, but they can be summed up as: this isn't a program that people have used in an active engagement, and it doesn't really have too much in common with real malware threats yet.

Signatures and signature-derived heuristics (ex fuzzy hashes) won't catch this because it's all-new.

Behavioral analysis engines may or may not catch it because it's simple.

Classification algorithms may or may not recognize it, but I think that has to do with the above - it's surely malicious, but it's not really dangerous.

## Reverse Engineering & Obfuscation

* ghidra time

Your code is minimally obscured, and its function is easily ascertained with any reverse engineering suite. Any Jr. Analyst that knows x86 would figure out exactly what it is and does immediately, raising the alarms, when you ideally want to pass at least a sniff test here to call it "undetectable."

Start researching malware obfuscation. Reverse engineer your binaries. Find out what the big boys are doing!

Upload it to VirusTotal again - do more scanners pick it up, even though analysts might not have such an easy time anymore? Explore why or why not! Keep learning!

## Extending and Advancing

So it's lean, but maybe make it mean, can you get to bigger and badder targets? How about dumping out Windows credentials from the registry? Can your malware install itself as a service for persistence? How do other malware strains do those things?

* you're using a VCS, RIGHT?
* research time
* scanning & rescanning to see if there are any particular changes that strongly influence detection rates from the host protection perspective

## Networking, Traffic Inspection, and Threat Intelligence

* IDS fundamentals
* threat protection fundamentals, what's plaintext, what's not; protocols
* what's your infrastructure look like? what would happen if you tried to run this for real? ISP + VPS payment traces etc.

What would happen if you tried to deploy this to an area where sensitive information - even something as "benign" as a browser history - was of critical importance? Would contemporary NGFWs or UTMs permit the use of outgoing FTP to an untrusted server? Would you have been better off using a more common protocol, such as HTTPS (both to blend in and to encrypt the data you are sending in transit)?

## Application Security for Malware Authors

* can you hack your own malware?
* are malicious clients authed?
* could you DoS your server?
* provide examples of shitty malware fiestas

## Further Works & Closing Thoughts

* start from scratch for your next projects, this one's a mess
* new people in the malware field bring tons of fresh ideas and content
* living document et al.


Languages

: Optiminsinasd